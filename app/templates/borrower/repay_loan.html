{% extends "base1.html" %}
{% block content %}

<!-- Messages -->
{% if messages %}
<div class="max-w-5xl mx-auto mb-6">
    {% for message in messages %}
    <div class="p-4 rounded mb-2
        {% if message.tags == 'error' %}bg-red-100 text-red-800{% endif %}
        {% if message.tags == 'success' %}bg-green-100 text-green-800{% endif %}
        {% if message.tags == 'warning' %}bg-yellow-100 text-yellow-800{% endif %}
        {% if message.tags == 'info' %}bg-blue-100 text-blue-800{% endif %}
    ">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}
<div class="max-w-5xl mx-auto">

    <!-- Page Header -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold mb-1">Pay Loan</h2>
        <p class="text-gray-500">Make a payment towards your active loans</p>
    </div>

    <div class="grid md:grid-cols-2 gap-6">

        <!-- LEFT SIDE: Payment Details -->
        <div class="bg-white shadow rounded-xl p-6">

            <h3 class="text-xl font-semibold">Payment Details</h3>
            <p class="text-gray-500 mb-4 text-sm">Select loan and enter payment amount</p>

            <form method="POST" action="{% url 'repay_loan' %}" class="space-y-6">
                {% csrf_token %}

                <!-- Select Loan -->
                <div class="space-y-2">
                    <label for="loan" class="text-sm font-medium">Select Loan</label>
                    <select name="loan" id="loan" required onchange="this.form.submit()"
                        class="w-full border rounded-lg px-4 py-2 bg-white focus:ring focus:ring-blue-300">

                        <option value="" disabled {% if not selected_loan_data %}selected{% endif %}>Choose a loan</option>

                        {% for loan in active_loans %}
                        <option value="{{ loan.id }}" {% if selected_loan_data and selected_loan_data.id == loan.id %}selected{% endif %}>
                            {{ loan.purpose }} (Loan #{{ loan.id }}) - ${{ loan.balance|floatformat:2 }} remaining
                        </option>
                        {% endfor %}

                    </select>
                </div>

                <!-- Show selected loan summary -->
                {% if selected_loan_data %}
                <div class="p-4 bg-gray-100 rounded-lg space-y-2">

                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Outstanding Balance</span>
                        <span class="font-semibold">
                            ${{ selected_loan_data.balance|floatformat:2 }}
                        </span>
                    </div>

                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Monthly Payment</span>
                        <span class="font-semibold">
                            ${{ selected_loan_data.monthly_payment|floatformat:2 }}
                        </span>
                    </div>

                </div>
                {% endif %}

                <!-- Payment Amount -->
                <div class="space-y-2">
                    <label for="amount" class="text-sm font-medium">Payment Amount ($)</label>
                    <input type="number" name="amount" id="amount" step="0.01" min="1" placeholder="Enter amount" required
                        class="w-full border rounded-lg px-4 py-2 focus:ring focus:ring-blue-300"/>

                    {% if selected_loan_data %}
                    <div class="flex gap-2 mt-2">
                        <button type="button"
                            onclick="document.getElementById('amount').value='{{ selected_loan_data.monthly_payment }}'"
                            class="border px-3 py-1 rounded-lg text-sm hover:bg-gray-100">
                            Monthly Payment
                        </button>

                        <button type="button"
                            onclick="document.getElementById('amount').value='{{ selected_loan_data.balance }}'"
                            class="border px-3 py-1 rounded-lg text-sm hover:bg-gray-100">
                            Full Balance
                        </button>
                    </div>
                    {% endif %}
                </div>

                <!-- Payment Method Info -->
                <div class="space-y-3">
                    <p class="text-sm font-medium">Payment Method</p>
                    <div class="p-3 border border-green-300 bg-green-50 rounded-lg">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">ðŸ“±</span>
                            <div>
                                <p class="font-medium text-green-800">M-Pesa</p>
                                <p class="text-xs text-green-600">Instant & Secure Payment</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                {% if selected_loan_data %}
                <button type="submit"
                    class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-medium">
                    Pay with M-Pesa
                </button>
                {% else %}
                <button type="button" disabled
                    class="w-full bg-gray-400 text-white py-3 rounded-lg cursor-not-allowed font-medium">
                    Select a loan to continue
                </button>
                {% endif %}
            </form>
        </div>

        <!-- RIGHT SIDE: Payment Summary -->
        <div class="space-y-6">

            <!-- Summary -->
            <div class="bg-white shadow rounded-xl p-6">
                <h3 class="text-xl font-semibold mb-1">Payment Summary</h3>
                <p class="text-gray-500 mb-4 text-sm">Review your payment details</p>

                <!-- Loan -->
                <div class="flex justify-between py-3 border-b">
                    <span class="text-gray-500">Loan</span>
                    <span class="font-medium">
                        {% if selected_loan_data %}
                            {{ selected_loan_data.purpose }} #{{ selected_loan_data.id }}
                        {% else %}
                            -
                        {% endif %}
                    </span>
                </div>

                <!-- Outstanding Balance -->
                <div class="flex justify-between py-3 border-b">
                    <span class="text-gray-500">Outstanding Balance</span>
                    <span class="font-medium">
                        {% if selected_loan_data %}
                            ${{ selected_loan_data.balance|floatformat:2 }}
                        {% else %}
                            -
                        {% endif %}
                    </span>
                </div>

                <!-- Payment Method -->
                <div class="flex justify-between py-3 border-b">
                    <span class="text-gray-500">Payment Method</span>
                    <span class="font-medium">
                        M-Pesa
                    </span>
                </div>

                <!-- Monthly Payment -->
                {% if selected_loan_data %}
                <div class="flex justify-between pt-4 text-sm text-gray-600">
                    <span>Recommended Monthly Payment</span>
                    <span class="font-semibold">${{ selected_loan_data.monthly_payment|floatformat:2 }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Payment Tips -->
            <div class="bg-white shadow rounded-xl p-6">
                <h3 class="text-xl font-semibold mb-2">Payment Tips</h3>

                <ul class="text-gray-600 text-sm space-y-2">
                    <li class="flex items-start gap-2">
                        <span class="text-green-600 mt-0.5">âœ“</span>
                        <span>Check your phone for M-Pesa STK push</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-green-600 mt-0.5">âœ“</span>
                        <span>Enter your M-Pesa PIN to complete payment</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-green-600 mt-0.5">âœ“</span>
                        <span>Payment is processed instantly</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-green-600 mt-0.5">âœ“</span>
                        <span>Paying more reduces interest charges</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-green-600 mt-0.5">âœ“</span>
                        <span>Early repayment has no penalties</span>
                    </li>
                </ul>
            </div>

            {% if not active_loans %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6">
                <p class="text-yellow-800 text-sm">
                    You don't have any active loans at the moment.
                </p>
            </div>
            {% endif %}

        </div>
    </div>
</div>

{% endblock %}