{% extends "base1.html" %}
{% block content %}

<h1 class="text-3xl font-bold mb-4">Repay Loan</h1>
<!-- Messages -->
{% if messages %}
<div class="max-w-5xl mx-auto mb-6">
    {% for message in messages %}
    <div class="p-4 rounded mb-2
        {% if message.tags == 'error' %}bg-red-100 text-red-800{% endif %}
        {% if message.tags == 'success' %}bg-green-100 text-green-800{% endif %}
        {% if message.tags == 'warning' %}bg-yellow-100 text-yellow-800{% endif %}
        {% if message.tags == 'info' %}bg-blue-100 text-blue-800{% endif %}
    ">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}
<div class="max-w-5xl mx-auto">

    <!-- Page Header -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold mb-1">Pay Loan</h2>
        <p class="text-gray-500">Make a payment towards your active loans</p>
    </div>

    <div class="grid md:grid-cols-2 gap-6">

        <!-- LEFT SIDE: Payment Details -->
        <div class="bg-white shadow rounded-xl p-6">

            <h3 class="text-xl font-semibold">Payment Details</h3>
            <p class="text-gray-500 mb-4 text-sm">Select loan and enter payment amount</p>

            <form method="POST" class="space-y-6">
                {% csrf_token %}

                <!-- Select Loan -->
                <div class="space-y-2">
                    <label for="loan" class="text-sm font-medium">Select Loan</label>
                    <select name="loan" id="loan" required
                        class="w-full border rounded-lg px-4 py-2 bg-white focus:ring focus:ring-blue-300">

                        <option value="" disabled selected>Choose a loan</option>

                       {% for loan in active_loans %}
<option value="{{ loan.id }}">
    {{ loan.purpose }} (Loan #{{ loan.id }}) - ${{ loan.balance|floatformat:2 }} remaining
</option>
{% endfor %}

                    </select>
                </div>

                <!-- Show selected loan summary -->
                {% if selected_loan_data %}
                <div class="p-4 bg-gray-100 rounded-lg space-y-2">

                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Outstanding Balance</span>
                        <span class="font-semibold">
                            ${{ selected_loan_data.balance|floatformat:0 }}
                        </span>
                    </div>

                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Monthly Payment</span>
                        <span class="font-semibold">
                            ${{ selected_loan_data.monthly_payment|floatformat:0 }}
                        </span>
                    </div>

                </div>
                {% endif %}

                <!-- Payment Amount -->
                <div class="space-y-2">
                    <label for="amount" class="text-sm font-medium">Payment Amount ($)</label>
                    <input type="number" name="amount" id="amount" placeholder="Enter amount" required
                        class="w-full border rounded-lg px-4 py-2 focus:ring focus:ring-blue-300"/>

                    {% if selected_loan_data %}
                    <div class="flex gap-2 mt-2">
                        <button type="button"
                            onclick="document.getElementById('amount').value='{{ selected_loan_data.monthly_payment }}'"
                            class="border px-3 py-1 rounded-lg text-sm hover:bg-gray-100">
                            Monthly Payment
                        </button>

                        <button type="button"
                            onclick="document.getElementById('amount').value='{{ selected_loan_data.balance }}'"
                            class="border px-3 py-1 rounded-lg text-sm hover:bg-gray-100">
                            Full Balance
                        </button>
                    </div>
                    {% endif %}
                </div>

                <!-- Payment Method -->
                <div class="space-y-3">
                    <p class="text-sm font-medium">Payment Method</p>

                    <div class="space-y-3">

                        <!-- Card -->
{#                        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-100">#}
{#                            <input type="radio" name="payment_method" value="card" required />#}
{#                            <span>Credit/Debit Card</span>#}
{#                        </label>#}

                        <!-- Bank -->
{#                        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-100">#}
{#                            <input type="radio" name="payment_method" value="bank" />#}
{#                            <span>Bank Transfer</span>#}
{#                        </label>#}

                        <!-- Wallet -->
<form method="POST" action="{% url 'repay_loan' %}">
    {% csrf_token %}
    <input type="hidden" name="loan_id" value="{{ selected_loan_data.id }}">
    <input type="number" name="amount" value="{{ selected_loan_data.balance }}" required>
    <button type="submit" class="btn btn-primary">Pay with M-Pesa</button>
</form>
{#                        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-100">#}
{#                            <input type="radio" name="payment_method" value="mpesa" />#}
{#                            <span>M-Pesa</span>#}
{#                        </label>#}

                    </div>
                </div>

                <!-- Submit -->
{#                <button type="submit"#}
{#                    class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition">#}
{#                    Make Payment#}
{#                </button>#}
            </form>
        </div>

        <!-- RIGHT SIDE: Payment Summary -->
        <div class="space-y-6">

            <!-- Summary -->
            <div class="bg-white shadow rounded-xl p-6">
                <h3 class="text-xl font-semibold mb-1">Payment Summary</h3>
                <p class="text-gray-500 mb-4 text-sm">Review your payment details</p>

                <!-- Loan -->
                <div class="flex justify-between py-3 border-b">
                    <span class="text-gray-500">Loan</span>
                    <span class="font-medium">
                        {% if selected_loan_data %} {{ selected_loan_data.name }} {% else %}-{% endif %}
                    </span>
                </div>

                <!-- Payment Amount -->
                <div class="flex justify-between py-3 border-b">
                    <span class="text-gray-500">Payment Amount</span>
                    <span class="font-medium">
                        {% if payment_amount %} ${{ payment_amount }} {% else %}-{% endif %}
                    </span>
                </div>

                <!-- Payment Method -->
                <div class="flex justify-between py-3 border-b">
                    <span class="text-gray-500">Payment Method</span>
                    <span class="font-medium capitalize">
                        {% if payment_method %}
                            {% if payment_method == "card" %}Credit/Debit Card{% endif %}
                            {% if payment_method == "bank" %}Bank Transfer{% endif %}
                            {% if payment_method == "wallet" %}Digital Wallet{% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </span>
                </div>

                <!-- Remaining -->
                {% if selected_loan_data and payment_amount %}
                <div class="flex justify-between pt-4">
                    <span class="font-semibold">Remaining After Payment</span>
                    <span class="font-bold text-blue-600">
                        ${{ selected_loan_data.balance|floatformat:0|add:"-|payment_amount" }}
                    </span>
                </div>
                {% endif %}
            </div>

            <!-- Payment Tips -->
            <div class="bg-white shadow rounded-xl p-6">
                <h3 class="text-xl font-semibold mb-2">Payment Tips</h3>

                <ul class="text-gray-600 text-sm space-y-1">
                    <li>• Payments are processed instantly</li>
                    <li>• Paying more reduces interest</li>
                    <li>• Early repayment has no penalties</li>
                    <li>• Keep your receipts for your records</li>
                </ul>
            </div>

        </div>
    </div>
</div>

{% endblock %}
