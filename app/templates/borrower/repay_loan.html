{% extends "base1.html" %}
{% block content %}

<!-- Messages -->
{% if messages %}
<div class="max-w-5xl mx-auto mb-6">
    {% for message in messages %}
    <div class="p-4 rounded mb-2
        {% if message.tags == 'error' %}bg-red-100 text-red-800{% endif %}
        {% if message.tags == 'success' %}bg-green-100 text-green-800{% endif %}
        {% if message.tags == 'warning' %}bg-yellow-100 text-yellow-800{% endif %}
        {% if message.tags == 'info' %}bg-blue-100 text-blue-800{% endif %}
    ">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="max-w-5xl mx-auto">

    <!-- Page Header -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold mb-1">Pay Loan</h2>
        <p class="text-gray-500">Make a payment towards your active loans</p>
    </div>

    <div class="grid md:grid-cols-2 gap-6">

        <!-- LEFT SIDE: Payment Details -->
        <div class="bg-white shadow rounded-xl p-6">

            <h3 class="text-xl font-semibold">Payment Details</h3>
            <p class="text-gray-500 mb-4 text-sm">Select loan and enter payment amount</p>

            <form method="POST" action="{% url 'repay_loan' %}" class="space-y-6" id="paymentForm">
                {% csrf_token %}

                <!-- Select Loan -->
                <div class="space-y-2">
                    <label for="loan" class="text-sm font-medium">Select Loan</label>
                    <select name="loan" id="loan" required onchange="this.form.submit()"
                        class="w-full border rounded-lg px-4 py-2 bg-white focus:ring focus:ring-blue-300">

                        <option value="" disabled {% if not selected_loan_data %}selected{% endif %}>Choose a loan</option>

                        {% for loan in active_loans %}
                        <option value="{{ loan.id }}" {% if selected_loan_data and selected_loan_data.id == loan.id %}selected{% endif %}>
                            {{ loan.purpose }} (Loan #{{ loan.id }}) - ${{ loan.balance|floatformat:2 }} remaining
                        </option>
                        {% endfor %}

                    </select>
                </div>

                <!-- Show selected loan summary -->
                {% if selected_loan_data %}
                <div class="p-4 bg-gray-100 rounded-lg space-y-2">

                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Outstanding Balance</span>
                        <span class="font-semibold">
                            ${{ selected_loan_data.balance|floatformat:2 }}
                        </span>
                    </div>

                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Monthly Payment</span>
                        <span class="font-semibold">
                            ${{ selected_loan_data.monthly_payment|floatformat:2 }}
                        </span>
                    </div>

                </div>
                {% endif %}

                <!-- Payment Amount -->
                <div class="space-y-2">
                    <label for="amount" class="text-sm font-medium">Payment Amount ($)</label>
                    <input type="number" name="amount" id="amount" step="0.01" min="1" placeholder="Enter amount" required
                        class="w-full border rounded-lg px-4 py-2 focus:ring focus:ring-blue-300"/>

                    {% if selected_loan_data %}
                    <div class="flex gap-2 mt-2">
                        <button type="button"
                            onclick="document.getElementById('amount').value='{{ selected_loan_data.monthly_payment }}'"
                            class="border px-3 py-1 rounded-lg text-sm hover:bg-gray-100">
                            Monthly Payment
                        </button>

                        <button type="button"
                            onclick="document.getElementById('amount').value='{{ selected_loan_data.balance }}'"
                            class="border px-3 py-1 rounded-lg text-sm hover:bg-gray-100">
                            Full Balance
                        </button>
                    </div>
                    {% endif %}
                </div>

                <!-- Payment Method Selection -->
                <div class="space-y-3">
                    <p class="text-sm font-medium">Select Payment Method</p>

                    <!-- M-Pesa Option -->
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition payment-method-option"
                           onclick="selectPaymentMethod('mpesa')">
                        <input type="radio" name="payment_method" value="mpesa" id="mpesa_radio"
                               class="w-5 h-5 text-green-600" required>
                        <div class="ml-3 flex-1">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">ðŸ“±</span>
                                <div>
                                    <p class="font-medium text-gray-800">M-Pesa</p>
                                    <p class="text-xs text-gray-600">Pay via STK Push</p>
                                </div>
                            </div>
                        </div>
                        <span class="text-green-600 font-semibold">Instant</span>
                    </label>

                    <!-- Manual Payment Option -->
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition payment-method-option"
                           onclick="selectPaymentMethod('manual')">
                        <input type="radio" name="payment_method" value="manual" id="manual_radio"
                               class="w-5 h-5 text-blue-600" required>
                        <div class="ml-3 flex-1">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">ðŸ’³</span>
                                <div>
                                    <p class="font-medium text-gray-800">Manual Payment</p>
                                    <p class="text-xs text-gray-600">Direct deduction (Testing)</p>
                                </div>
                            </div>
                        </div>
                        <span class="text-blue-600 font-semibold">Instant</span>
                    </label>
                </div>

                <!-- Submit Button (changes based on payment method) -->
                {% if selected_loan_data %}
                <button type="submit" id="submitBtn"
                    class="w-full bg-gray-400 text-white py-3 rounded-lg cursor-not-allowed transition font-medium" disabled>
                    Select Payment Method
                </button>
                {% else %}
                <button type="button" disabled
                    class="w-full bg-gray-400 text-white py-3 rounded-lg cursor-not-allowed font-medium">
                    Select a loan to continue
                </button>
                {% endif %}
            </form>
        </div>

        <!-- RIGHT SIDE: Payment Summary -->
        <div class="space-y-6">

            <!-- Summary -->
            <div class="bg-white shadow rounded-xl p-6">
                <h3 class="text-xl font-semibold mb-1">Payment Summary</h3>
                <p class="text-gray-500 mb-4 text-sm">Review your payment details</p>

                <!-- Loan -->
                <div class="flex justify-between py-3 border-b">
                    <span class="text-gray-500">Loan</span>
                    <span class="font-medium">
                        {% if selected_loan_data %}
                            {{ selected_loan_data.purpose }} #{{ selected_loan_data.id }}
                        {% else %}
                            -
                        {% endif %}
                    </span>
                </div>

                <!-- Outstanding Balance -->
                <div class="flex justify-between py-3 border-b">
                    <span class="text-gray-500">Outstanding Balance</span>
                    <span class="font-medium">
                        {% if selected_loan_data %}
                            ${{ selected_loan_data.balance|floatformat:2 }}
                        {% else %}
                            -
                        {% endif %}
                    </span>
                </div>

                <!-- Payment Method -->
                <div class="flex justify-between py-3 border-b">
                    <span class="text-gray-500">Payment Method</span>
                    <span class="font-medium" id="selectedMethodDisplay">
                        Not selected
                    </span>
                </div>

                <!-- Monthly Payment -->
                {% if selected_loan_data %}
                <div class="flex justify-between pt-4 text-sm text-gray-600">
                    <span>Recommended Monthly Payment</span>
                    <span class="font-semibold">${{ selected_loan_data.monthly_payment|floatformat:2 }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Payment Tips -->
            <div class="bg-white shadow rounded-xl p-6">
                <h3 class="text-xl font-semibold mb-2">Payment Methods</h3>

                <div class="space-y-4">
                    <!-- M-Pesa Info -->
                    <div class="p-3 bg-green-50 rounded-lg">
                        <p class="font-medium text-green-800 mb-1">ðŸ“± M-Pesa</p>
                        <ul class="text-sm text-green-700 space-y-1">
                            <li>â€¢ Check phone for STK push</li>
                            <li>â€¢ Enter M-Pesa PIN</li>
                            <li>â€¢ Instant confirmation</li>
                        </ul>
                    </div>

                    <!-- Manual Info -->
                    <div class="p-3 bg-blue-50 rounded-lg">
                        <p class="font-medium text-blue-800 mb-1">ðŸ’³ Manual Payment</p>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>â€¢ Instant deduction</li>
                            <li>â€¢ For testing purposes</li>
                            <li>â€¢ No phone verification needed</li>
                        </ul>
                    </div>
                </div>
            </div>

            {% if not active_loans %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6">
                <p class="text-yellow-800 text-sm">
                    You don't have any active loans at the moment.
                </p>
            </div>
            {% endif %}

        </div>
    </div>
</div>

<script>
function selectPaymentMethod(method) {
    // Update radio button
    if (method === 'mpesa') {
        document.getElementById('mpesa_radio').checked = true;
    } else {
        document.getElementById('manual_radio').checked = true;
    }

    // Update visual feedback
    document.querySelectorAll('.payment-method-option').forEach(option => {
        option.classList.remove('border-green-500', 'border-blue-500', 'bg-green-50', 'bg-blue-50', 'border-2');
    });

    const selectedOption = event.currentTarget;
    if (method === 'mpesa') {
        selectedOption.classList.add('border-green-500', 'bg-green-50', 'border-2');
    } else {
        selectedOption.classList.add('border-blue-500', 'bg-blue-50', 'border-2');
    }

    // Update submit button
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');

        if (method === 'mpesa') {
            submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            submitBtn.textContent = 'Pay with M-Pesa';
        } else {
            submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            submitBtn.textContent = 'Process Manual Payment';
        }
    }

    // Update summary display
    const display = document.getElementById('selectedMethodDisplay');
    if (display) {
        display.textContent = method === 'mpesa' ? 'M-Pesa' : 'Manual Payment';
    }
}

// Prevent form submission without payment method
document.getElementById('paymentForm')?.addEventListener('submit', function(e) {
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
    if (!paymentMethod) {
        e.preventDefault();
        alert('Please select a payment method');
    }
});
</script>

{% endblock %}